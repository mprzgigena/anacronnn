// ==================================================================================
// ANACRON - ESQUEMA DE BASE DE DATOS PARA SISTEMA DE GESTI√ìN M√âDICA
// ==================================================================================
//
// üìã DESCRIPCI√ìN GENERAL:
// Sistema simplificado de gesti√≥n m√©dica desarrollado como proyecto escolar.
// Permite gestionar turnos m√©dicos, pacientes, profesionales y establecimientos.
//
// üèóÔ∏è TECNOLOG√çAS:
// - ORM: Prisma v6.19.0
// - Base de Datos: MySQL 
// - Framework: NestJS + TypeScript
// - Conexi√≥n: DATABASE_URL="mysql://root:@localhost:3306/anacron"
//
// üìä ESTRUCTURA DE DATOS:
// - 9 Tablas principales
// - 2 Tablas intermedias (Many-to-Many)
// - 2 Enums para validaci√≥n
// - Relaciones con integridad referencial
//
// ==================================================================================
// üìÅ TABLAS PRINCIPALES (7 entidades de negocio):
// ==================================================================================
//
// 1. üë§ PACIENTES (pacientes)
//    - Informaci√≥n personal de pacientes
//    - Conexi√≥n: obra social (opcional)
//    - Campos √∫nicos: dni, email
//    - √çndices: dni, email, obra_social_id
//
// 2. üè• ESTABLECIMIENTOS (establecimientos) 
//    - Cl√≠nicas, hospitales, centros m√©dicos
//    - Horarios de atenci√≥n (VARCHAR para compatibilidad)
//    - Tipos: CLINICA, HOSPITAL, LABORATORIO, etc.
//    - Conexi√≥n: profesionales, obras sociales
//
// 3. üë®‚Äç‚öïÔ∏è PROFESIONALES (profesionales)
//    - M√©dicos y especialistas
//    - Matr√≠cula profesional √∫nica
//    - Conexi√≥n obligatoria: establecimiento
//    - Relaci√≥n M:N con especialidades
//
// 4. ü©∫ ESPECIALIDADES (especialidades)
//    - Cardiolog√≠a, Traumatolog√≠a, etc.
//    - Duraci√≥n estimada en minutos
//    - Relaci√≥n M:N con profesionales
//
// 5. üìÖ TURNOS (turnos) ‚≠ê N√öCLEO DEL SISTEMA
//    - Sistema principal de citas m√©dicas
//    - Campos obligatorios: paciente, profesional, especialidad, establecimiento
//    - N√∫mero de referencia √∫nico autogenerado
//    - Estados: PENDIENTE, CONFIRMADO, COMPLETADO, CANCELADO, NO_ASISTIO
//    - Formato de hora: VARCHAR(10) ("HH:MM")
//
// 6. üõ°Ô∏è OBRAS SOCIALES (obras_sociales)
//    - Seguros m√©dicos y cobertura
//    - Tipo de cobertura configurable
//    - Relaci√≥n M:N con establecimientos
//
// 7. üìã HISTORIAL CONSULTAS (historial_consultas)
//    - Registro de consultas m√©dicas completadas
//    - Diagn√≥sticos, tratamientos, observaciones
//    - Puede crearse desde turno o manualmente
//    - Conexi√≥n opcional: turno origen
//
// ==================================================================================
// üìä TABLAS INTERMEDIAS (Many-to-Many):
// ==================================================================================
//
// 8. üë®‚Äç‚öïÔ∏è‚ÜîÔ∏èü©∫ PROFESIONAL_ESPECIALIDAD (profesional_especialidad)
//    - Un profesional puede tener m√∫ltiples especialidades
//    - Una especialidad puede ser ejercida por m√∫ltiples profesionales
//    - Constraint √∫nico: profesionalId + especialidadId
//
// 9. üè•‚ÜîÔ∏èüõ°Ô∏è ESTABLECIMIENTO_OBRA_SOCIAL (establecimiento_obra_social) 
//    - Un establecimiento acepta m√∫ltiples obras sociales
//    - Una obra social es aceptada en m√∫ltiples establecimientos
//    - Constraint √∫nico: establecimientoId + obraSocialId
//
// ==================================================================================
// üîó RELACIONES PRINCIPALES:
// ==================================================================================
//
// PACIENTE:
//   ‚îú‚îÄ‚îÄ obraSocial (Many-to-One) - Seguro m√©dico
//   ‚îú‚îÄ‚îÄ turnos (One-to-Many) - Citas programadas
//   ‚îî‚îÄ‚îÄ historialConsultas (One-to-Many) - Consultas realizadas
//
// ESTABLECIMIENTO:
//   ‚îú‚îÄ‚îÄ profesionales (One-to-Many) - Staff m√©dico
//   ‚îú‚îÄ‚îÄ turnos (One-to-Many) - Citas en el establecimiento
//   ‚îú‚îÄ‚îÄ historialConsultas (One-to-Many) - Consultas realizadas
//   ‚îî‚îÄ‚îÄ obrasSociales (Many-to-Many) - Seguros aceptados
//
// PROFESIONAL:
//   ‚îú‚îÄ‚îÄ establecimiento (Many-to-One) - Lugar de trabajo
//   ‚îú‚îÄ‚îÄ especialidades (Many-to-Many) - Especialidades m√©dicas
//   ‚îú‚îÄ‚îÄ turnos (One-to-Many) - Agenda de citas
//   ‚îî‚îÄ‚îÄ historialConsultas (One-to-Many) - Consultas realizadas
//
// TURNO: ‚≠ê ENTIDAD CENTRAL
//   ‚îú‚îÄ‚îÄ paciente (Many-to-One) - Qui√©n solicita
//   ‚îú‚îÄ‚îÄ profesional (Many-to-One) - Qui√©n atiende
//   ‚îú‚îÄ‚îÄ especialidad (Many-to-One) - Tipo de consulta
//   ‚îú‚îÄ‚îÄ establecimiento (Many-to-One) - D√≥nde se realiza
//   ‚îî‚îÄ‚îÄ historialConsultas (One-to-Many) - Registro post-consulta
//
// ==================================================================================
// üìã ENUMS DEFINIDOS:
// ==================================================================================
//
// üè• TipoEstablecimiento:
//   - CLINICA: Cl√≠nica privada
//   - LABORATORIO: Laboratorio de an√°lisis
//   - SANATORIO: Sanatorio privado  
//   - PARTICULAR: Consultorio particular
//   - HOSPITAL: Hospital p√∫blico/privado
//   - CENTRO_MEDICO: Centro m√©dico integral
//
// üìÖ EstadoTurno:
//   - PENDIENTE: Reci√©n creado, esperando confirmaci√≥n
//   - CONFIRMADO: Confirmado por paciente/profesional
//   - COMPLETADO: Consulta realizada exitosamente
//   - CANCELADO: Cancelado por alguna de las partes
//   - NO_ASISTIO: Paciente no se present√≥ a la cita
//
// ==================================================================================
// üîß DECISIONES T√âCNICAS:
// ==================================================================================
//
// ‚è∞ CAMPOS DE TIEMPO:
//   - horarioApertura/horarioCierre: VARCHAR(10) formato "HH:MM"
//   - horaTurno/horaConsulta: VARCHAR(10) formato "HH:MM"
//   - Raz√≥n: Evitar problemas de conversi√≥n MySQL TIME ‚Üî Prisma DateTime
//
// üîë CAMPOS √öNICOS:
//   - dni (pacientes): Documento √∫nico por paciente
//   - email (pacientes): Email √∫nico por paciente
//   - matricula (profesionales): Matr√≠cula profesional √∫nica
//   - numeroReferencia (turnos): N√∫mero autogenerado √∫nico por turno
//   - nombre (especialidades/obras_sociales): Nombres √∫nicos
//
// üìù TIMESTAMPS AUTOM√ÅTICOS:
//   - createdAt: Momento de creaci√≥n (autom√°tico)
//   - updatedAt: √öltima modificaci√≥n (autom√°tico en updates)
//
// üóëÔ∏è SOFT DELETE:
//   - Campo 'activo' en lugar de eliminar registros f√≠sicamente
//   - Permite mantener historial e integridad referencial
//
// üöÄ √çNDICES DE OPTIMIZACI√ìN:
//   - idx_dni, idx_email (pacientes): B√∫squedas frecuentes
//   - idx_matricula (profesionales): B√∫squeda por matr√≠cula
//   - idx_fecha, idx_estado (turnos): Consultas por fecha y estado  
//   - idx_tipo, idx_activo (establecimientos): Filtros comunes
//
// ==================================================================================
// üåê CONEXI√ìN CON NESTJS:
// ==================================================================================
//
// Esta schema se conecta con el backend NestJS de la siguiente manera:
//
// 1. üì¶ GENERACI√ìN DE CLIENTE:
//    - Comando: npx prisma generate
//    - Genera: @prisma/client en node_modules
//    - Usado en: [modulo].service.ts de cada m√≥dulo
//
// 2. üîó SERVICIOS NESTJS:
//    - pacientes.service.ts ‚Üê Paciente, ObraSocial
//    - establecimientos.service.ts ‚Üê Establecimiento, TipoEstablecimiento
//    - profesionales.service.ts ‚Üê Profesional, ProfesionalEspecialidad
//    - especialidades.service.ts ‚Üê Especialidad
//    - turnos.service.ts ‚Üê Turno, EstadoTurno (‚≠ê principal)
//    - obras-sociales.service.ts ‚Üê ObraSocial, EstablecimientoObraSocial
//    - historial-consultas.service.ts ‚Üê HistorialConsulta
//
// 3. üåç VARIABLES DE ENTORNO:
//    - DATABASE_URL: Conexi√≥n MySQL definida en .env
//    - Formato: "mysql://user:password@host:port/database"
//    - Ejemplo: "mysql://root:@localhost:3306/anacron"

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model ObraSocial {
  id                          Int                         @id @default(autoincrement())
  nombre                      String                      @unique(map: "nombre") @db.VarChar(100)
  tipoCobertura               String?                     @map("tipo_cobertura") @db.VarChar(50)
  activo                      Boolean?                    @default(true)
  createdAt                   DateTime                    @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt                   DateTime                    @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  establecimientoObraSociales EstablecimientoObraSocial[]
  pacientes                   Paciente[]

  @@map("obras_sociales")
}

model Paciente {
  id                 Int                 @id @default(autoincrement())
  nombre             String              @db.VarChar(50)
  apellido           String              @db.VarChar(50)
  dni                String              @unique(map: "dni") @db.VarChar(20)
  email              String?             @unique(map: "email") @db.VarChar(100)
  telefono           String?             @db.VarChar(20)
  fechaNacimiento    DateTime?           @map("fecha_nacimiento") @db.Date
  obraSocialId       Int?                @map("obra_social_id")
  activo             Boolean?            @default(true)
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt          DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  historialConsultas HistorialConsulta[]
  obraSocial         ObraSocial?         @relation(fields: [obraSocialId], references: [id], onUpdate: Restrict, map: "pacientes_ibfk_1")
  turnos             Turno[]

  @@index([dni], map: "idx_dni")
  @@index([email], map: "idx_email")
  @@index([obraSocialId], map: "obra_social_id")
  @@map("pacientes")
}

model Establecimiento {
  id                          Int                         @id @default(autoincrement())
  nombre                      String                      @db.VarChar(100)
  tipo                        TipoEstablecimiento
  direccion                   String?                     @db.VarChar(200)
  telefono                    String?                     @db.VarChar(20)
  email                       String?                     @db.VarChar(100)
  horarioApertura             String?                     @map("horario_apertura") @db.VarChar(10)
  horarioCierre               String?                     @map("horario_cierre") @db.VarChar(10)
  activo                      Boolean?                    @default(true)
  createdAt                   DateTime                    @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt                   DateTime                    @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  establecimientoObraSociales EstablecimientoObraSocial[]
  historialConsultas          HistorialConsulta[]
  profesionales               Profesional[]
  turnos                      Turno[]

  @@index([tipo], map: "idx_tipo")
  @@index([activo], map: "idx_activo")
  @@map("establecimientos")
}

model Especialidad {
  id                        Int                       @id @default(autoincrement())
  nombre                    String                    @unique(map: "nombre") @db.VarChar(100)
  descripcion               String?                   @db.Text
  duracionEstimadaMinutos   Int?                      @default(30) @map("duracion_estimada_minutos")
  activo                    Boolean?                  @default(true)
  createdAt                 DateTime                  @default(now()) @map("created_at") @db.Timestamp(0)
  historialConsultas        HistorialConsulta[]
  profesionalEspecialidades ProfesionalEspecialidad[]
  turnos                    Turno[]

  @@index([activo], map: "idx_activo")
  @@map("especialidades")
}

model Profesional {
  id                        Int                       @id @default(autoincrement())
  nombre                    String                    @db.VarChar(50)
  apellido                  String                    @db.VarChar(50)
  matricula                 String?                   @unique(map: "matricula") @db.VarChar(50)
  telefono                  String?                   @db.VarChar(20)
  email                     String?                   @db.VarChar(100)
  establecimientoId         Int                       @map("establecimiento_id")
  activo                    Boolean?                  @default(true)
  createdAt                 DateTime                  @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt                 DateTime                  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  historialConsultas        HistorialConsulta[]
  profesionalEspecialidades ProfesionalEspecialidad[]
  establecimiento           Establecimiento           @relation(fields: [establecimientoId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "profesionales_ibfk_1")
  turnos                    Turno[]

  @@index([matricula], map: "idx_matricula")
  @@index([establecimientoId], map: "idx_establecimiento")
  @@map("profesionales")
}

model ProfesionalEspecialidad {
  id             Int          @id @default(autoincrement())
  profesionalId  Int          @map("profesional_id")
  especialidadId Int          @map("especialidad_id")
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamp(0)
  profesional    Profesional  @relation(fields: [profesionalId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "profesional_especialidad_ibfk_1")
  especialidad   Especialidad @relation(fields: [especialidadId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "profesional_especialidad_ibfk_2")

  @@unique([profesionalId, especialidadId], map: "unique_prof_esp")
  @@index([especialidadId], map: "especialidad_id")
  @@map("profesional_especialidad")
}

model Turno {
  id                 Int                 @id @default(autoincrement())
  pacienteId         Int                 @map("paciente_id")
  profesionalId      Int                 @map("profesional_id")
  especialidadId     Int                 @map("especialidad_id")
  establecimientoId  Int                 @map("establecimiento_id")
  fechaTurno         DateTime            @map("fecha_turno") @db.Date
  horaTurno          String              @map("hora_turno") @db.VarChar(10)
  estado             EstadoTurno?        @default(PENDIENTE)
  observaciones      String?             @db.Text
  numeroReferencia   String?             @unique(map: "numero_referencia") @map("numero_referencia") @db.VarChar(50)
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt          DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  historialConsultas HistorialConsulta[]
  paciente           Paciente            @relation(fields: [pacienteId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "turnos_ibfk_1")
  profesional        Profesional         @relation(fields: [profesionalId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "turnos_ibfk_2")
  especialidad       Especialidad        @relation(fields: [especialidadId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "turnos_ibfk_3")
  establecimiento    Establecimiento     @relation(fields: [establecimientoId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "turnos_ibfk_4")

  @@index([fechaTurno], map: "idx_fecha")
  @@index([estado], map: "idx_estado")
  @@index([pacienteId], map: "idx_paciente")
  @@index([profesionalId], map: "idx_profesional")
  @@index([numeroReferencia], map: "idx_numero_ref")
  @@index([especialidadId], map: "especialidad_id")
  @@index([establecimientoId], map: "establecimiento_id")
  @@map("turnos")
}

model HistorialConsulta {
  id                Int             @id @default(autoincrement())
  pacienteId        Int             @map("paciente_id")
  profesionalId     Int             @map("profesional_id")
  especialidadId    Int             @map("especialidad_id")
  establecimientoId Int             @map("establecimiento_id")
  turnoId           Int?            @map("turno_id")
  fechaConsulta     DateTime        @map("fecha_consulta") @db.Date
  horaConsulta      String          @map("hora_consulta") @db.VarChar(10)
  tipoConsulta      String?         @map("tipo_consulta") @db.VarChar(100)
  diagnostico       String?         @db.Text
  tratamiento       String?         @db.Text
  observaciones     String?         @db.Text
  createdAt         DateTime        @default(now()) @map("created_at") @db.Timestamp(0)
  paciente          Paciente        @relation(fields: [pacienteId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "historial_consultas_ibfk_1")
  profesional       Profesional     @relation(fields: [profesionalId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "historial_consultas_ibfk_2")
  especialidad      Especialidad    @relation(fields: [especialidadId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "historial_consultas_ibfk_3")
  establecimiento   Establecimiento @relation(fields: [establecimientoId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "historial_consultas_ibfk_4")
  turno             Turno?          @relation(fields: [turnoId], references: [id], onUpdate: Restrict, map: "historial_consultas_ibfk_5")

  @@index([fechaConsulta], map: "idx_fecha_consulta")
  @@index([pacienteId], map: "idx_paciente_historial")
  @@index([profesionalId], map: "idx_profesional_historial")
  @@index([especialidadId], map: "especialidad_id")
  @@index([establecimientoId], map: "establecimiento_id")
  @@index([turnoId], map: "turno_id")
  @@map("historial_consultas")
}

model EstablecimientoObraSocial {
  id                Int             @id @default(autoincrement())
  establecimientoId Int             @map("establecimiento_id")
  obraSocialId      Int             @map("obra_social_id")
  createdAt         DateTime        @default(now()) @map("created_at") @db.Timestamp(0)
  establecimiento   Establecimiento @relation(fields: [establecimientoId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "establecimiento_obra_social_ibfk_1")
  obraSocial        ObraSocial      @relation(fields: [obraSocialId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "establecimiento_obra_social_ibfk_2")

  @@unique([establecimientoId, obraSocialId], map: "unique_est_obra")
  @@index([obraSocialId], map: "obra_social_id")
  @@map("establecimiento_obra_social")
}

enum TipoEstablecimiento {
  CLINICA
  LABORATORIO
  SANATORIO
  PARTICULAR
  HOSPITAL
  CENTRO_MEDICO
}

enum EstadoTurno {
  PENDIENTE
  CONFIRMADO
  COMPLETADO
  CANCELADO
  NO_ASISTIO
}
